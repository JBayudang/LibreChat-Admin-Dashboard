<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Soul Calibre Admin Dashboard</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        h1 { text-align: center; margin: 20px 0; }
        #totalCount { color: #8B4513; font-weight: bold; }
        .charts-container { display: flex; gap: 20px; margin-bottom: 40px; flex-wrap: wrap; justify-content: center; align-items: flex-end; }
        .chart-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); width: 320px; text-align: center; }
        .table-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); max-width: 1300px; margin: 0 auto; width: 95%; }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #userSearch { padding: 10px; width: 300px; border-radius: 8px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #eee; font-size: 0.8em; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.95em; }
        .btn-del { color: white; background: #e74c3c; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-edit { color: white; background: #3498db; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-weight: bold; margin-right: 5px; }
        .role-badge { background: #e1e8ed; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8em; }
        .role-admin { background: #d4edda; color: #155724; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 25px; border-radius: 12px; width: 400px; }
        footer { text-align: center; padding: 30px; color: #777; font-size: 0.9em; border-top: 1px solid #ddd; margin-top: 40px; }
    </style>
</head>
<body>
    <h1>LibreChat / Soul Calibre AI Dashboard</h1>
    <div style="text-align: right; max-width: 1300px; margin: 0 auto;">
        <a href="/logout" style="text-decoration: none; color: #e74c3c; font-weight: bold;">Logout</a>
    </div>
    <div class="charts-container">
        <div class="chart-card"><h3>RAM Usage</h3><canvas id="ramChart"></canvas></div>
        <div class="chart-card"><h3>API Usage (Past 7 Days)</h3><canvas id="usageChart"></canvas></div>
        <div class="chart-card"><h3>Disk Usage</h3><canvas id="diskChart"></canvas></div>
    </div>
    <div class="table-container">
        <div class="table-header">
            <h2>Registered Users <span id="totalCount">0</span></h2>
            <input type="text" id="userSearch" placeholder="Search name, email, username, or role...">
        </div>
        <table id="userTable">
            <thead>
                <tr>
                    <th>Full Name</th><th>Email</th><th>Username</th><th>Role</th><th style="text-align:center;">Msg. Count</th><th>Reg. Date</th><th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="editModal" class="modal"><div class="modal-content"><h3>Edit User</h3><input type="hidden" id="editOriginalEmail"><input type="text" id="editName"><input type="email" id="editEmail"><input type="text" id="editUsername"><select id="editRole"><option value="USER">USER</option><option value="ADMIN">ADMIN</option></select><button onclick="saveUser()" style="background:#27ae60; color:white; width:100%; margin-top:10px; padding:10px; border:none; border-radius:4px; cursor:pointer;">Save Changes</button><button onclick="closeModal()" style="width:100%; margin-top:5px; padding:10px; border:none; border-radius:4px; cursor:pointer;">Cancel</button></div></div>
    <footer>Â© Jonathan P. Bayudang. All Rights Reserved.</footer>
    <script>
        let ramChart, diskChart, usageChart;
        let allUsers = [];
        const vibrantColors = ['#e67e22', '#2980b9', '#27ae60', '#f1c40f', '#c0392b', '#16a085', '#d35400'];

        function getHealthColor(pFree) { return pFree >= 50 ? '#2ecc71' : (pFree >= 15 ? '#f1c40f' : '#e74c3c'); }

        async function updateStats() {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();
                const usageRes = await fetch('/api/usage-history');
                const history = await usageRes.json();
                const formatGB = (b) => (b / 1024 / 1024 / 1024).toFixed(2);

                const ramUsedGB = formatGB(stats.ram.used);
                const ramFreeGB = formatGB(stats.ram.total - stats.ram.used);
                const ramFreePct = ((stats.ram.total - stats.ram.used) / stats.ram.total) * 100;
                const ramLabels = [`Used (${ramUsedGB} GB)`, `Free (${ramFreeGB} GB)`];

                if (!ramChart) {
                    ramChart = new Chart(document.getElementById('ramChart'), {
                        type: 'doughnut',
                        data: { labels: ramLabels, datasets: [{ data: [stats.ram.used, stats.ram.total - stats.ram.used], backgroundColor: ['#8e44ad', getHealthColor(ramFreePct)] }] }
                    });
                } else {
                    ramChart.data.labels = ramLabels;
                    ramChart.data.datasets[0].data = [stats.ram.used, stats.ram.total - stats.ram.used];
                    ramChart.data.datasets[0].backgroundColor[1] = getHealthColor(ramFreePct);
                    ramChart.update('none');
                }

                if (!usageChart) {
                    usageChart = new Chart(document.getElementById('usageChart'), {
                        type: 'bar',
                        data: { labels: history.map(h => h.date), datasets: [{ data: history.map(h => h.count), backgroundColor: vibrantColors }] },
                        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                    });
                } else {
                    usageChart.data.datasets[0].data = history.map(h => h.count);
                    usageChart.update();
                }

                const diskUsedGB = formatGB(stats.disk.used);
                const diskFreeGB = formatGB(stats.disk.total - stats.disk.used);
                const diskFreePct = ((stats.disk.total - stats.disk.used) / stats.disk.total) * 100;
                const diskLabels = [`Used (${diskUsedGB} GB)`, `Free (${diskFreeGB} GB)`];

                if (!diskChart) {
                    diskChart = new Chart(document.getElementById('diskChart'), {
                        type: 'doughnut',
                        data: { labels: diskLabels, datasets: [{ data: [stats.disk.used, stats.disk.total - stats.disk.used], backgroundColor: ['#009ca6', getHealthColor(diskFreePct)] }] }
                    });
                } else {
                    diskChart.data.labels = diskLabels;
                    diskChart.data.datasets[0].data = [stats.disk.used, stats.disk.total - stats.disk.used];
                    diskChart.data.datasets[0].backgroundColor[1] = getHealthColor(diskFreePct);
                    diskChart.update('none');
                }
            } catch (e) { console.error(e); }
        }

        async function loadUsers() {
            const res = await fetch('/api/users');
            allUsers = await res.json();
            document.getElementById('totalCount').innerText = allUsers.length;
            renderTable(allUsers);
        }

        function renderTable(users) {
            document.querySelector('#userTable tbody').innerHTML = users.map(u => `
                <tr>
                    <td><strong>${u.name || 'N/A'}</strong></td>
                    <td>${u.email}</td>
                    <td><code>${u.username || 'N/A'}</code></td>
                    <td><span class="role-badge ${u.role === 'ADMIN' ? 'role-admin' : ''}">${u.role || 'USER'}</span></td>
                    <td style="text-align:center;"><b>${u.totalMessages}</b></td>
                    <td>${u.createdAt ? new Date(u.createdAt).toLocaleDateString() : 'N/A'}</td>
                    <td><button class="btn-edit" onclick="openEditModal('${u.email}')">Edit</button><button class="btn-del" onclick="deleteUser('${u.email}')">Remove</button></td>
                </tr>
            `).join('');
        }

        function openEditModal(email) {
            const u = allUsers.find(x => x.email === email);
            document.getElementById('editOriginalEmail').value = u.email;
            document.getElementById('editName').value = u.name || '';
            document.getElementById('editEmail').value = u.email;
            document.getElementById('editUsername').value = u.username || '';
            document.getElementById('editRole').value = u.role || 'USER';
            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() { document.getElementById('editModal').style.display = 'none'; }

        async function saveUser() {
            const res = await fetch(`/api/users/${document.getElementById('editOriginalEmail').value}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: document.getElementById('editName').value, email: document.getElementById('editEmail').value, username: document.getElementById('editUsername').value, role: document.getElementById('editRole').value })
            });
            if (res.ok) { closeModal(); loadUsers(); }
        }

        document.getElementById('userSearch').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            renderTable(allUsers.filter(u => 
                (u.name && u.name.toLowerCase().includes(term)) || 
                (u.email && u.email.toLowerCase().includes(term)) ||
                (u.username && u.username.toLowerCase().includes(term)) ||
                (u.role && u.role.toLowerCase().includes(term))
            ));
        });

        async function deleteUser(email) {
            if(confirm(`Delete ${email}?`)) { await fetch(`/api/users/${email}`, { method: 'DELETE' }); loadUsers(); }
        }

        setInterval(updateStats, 3000);
        setInterval(loadUsers, 15000);
        updateStats(); loadUsers();
    </script>
</body>
</html>
